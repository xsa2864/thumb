<extend name="Public:base" />

<block name="main">
<br>
<ul class="sui-breadcrumb">
    <li><a href="#">首页</a></li>
    <li class="active">分类列表</li>
</ul>

<button class="sui-btn btn-primary" onclick="cate_add()">添加分类</button>
<button id="J_addsuppliers" data-toggle="modal" data-target="#J_addsuppliersDialog" data-width="large" data-backdrop="static" style="display: none">添加分类</button>


<table class="sui-table">
  <thead>
    <tr>
      <th>#</th>
      <th>分类名称</th>
      <th>分类等级</th>
      <th>上级分类</th>
      <th>排序</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
  	<volist name="tree" id="vo" key="k">  	
	  <tr id="c_{$k}">
      <td>{$k}</td>
      <td>{$vo.name}</td>
      <td>{$vo.level}</td>
      <td>顶级分类</td>
      <td>{$vo.sort}</td>
      <td>
        <a href="javascript:cate_add('{$vo.name}',{$vo.pid},{$vo.id})">添加</a>
        <a href="javascript:cate_edit({$vo.id},'{$vo.name}')">编辑</a>
        <a href="javascript:del({$vo.id},'c_{$k}');">删除</a>
      </td>
    </tr>   
        <volist name="vo.child" id="child" key="ck">  
        <tr id="c_{$k}{$ck}">
           <td></td>
           <td>{$child.name}</td>
           <td>{$child.level}</td>
           <td>{$vo.name}</td>
           <td>{$child.sort}</td>
           <td>
             <!-- <a href="javascript:cate_add('{$vo.name}',{$child.pid},{$child.cat_id})">添加</a> -->
             <a href="javascript:cate_edit({$child.id},'{$vo.name}')">编辑</a>
             <a href="javascript:del({$child.id},'c_{$k}{$ck}');">删除</a>
           </td>
        </tr>
        </volist>  
  	</volist>
  </tbody>
</table>




<div id="J_addsuppliersDialog" tabindex="-1" role="dialog" class="sui-modal hide fade" data-addsupplierurl="http://" data-getsuppliersurl="http://xxx">

  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button>
              <h4 id="myModalLabel" class="modal-title">添加分类</h4>
          </div>
          <div class="modal-body sui-form form-horizontal">
              <table class="sui-table table-bordered-simple">
                <thead>
                    <tr>
                        <th>分类名称</th>
                        <th>分类等级</th>
                        <th>上级分类</th>
                        <th>排序</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" name="name" id="name" /></td>
                        <td><input type="text" name="level" id="level" /></td>
                        <td>
                          <span id="pid_name"></span>
                          <input type="hidden" name="pid" id="pid" />
                        </td>
                        <td><input type="text" name="sort" id="sort" /></td>
                        <td data-supplierid="111">
                            <input type="hidden" name="action" id="action" />
                            <input type="hidden" name="cat_id" id="cat_id" />
                            <button class="sui-btn btn-small J_addOneSupplier">保存</button>
                        </td>
                    </tr>
                </tbody>
              </table>
          </div>
      </div>
  </div>
</div>


<script>  
  $(".J_addOneSupplier").click(function(){
    var name = $("#name").val();
    var level = $("#level").val();
    var pid = $("#pid").val();
    var seq = $("#seq").val();
    var action = $("#action").val();
    var cat_id = $("#cat_id").val();
    $.ajax({
        url:"{:U('Category/edit')}",
        type:'post',
        data:{action:action,name:name,level:level,pid:pid,seq:seq,cat_id:cat_id},
        dataType:'json',
        success:function(data){
            if(data.code == 1){
               location.replace(location.href);
            }else{
              alert(data.msg);
            }
        }
    });
  });

  // 添加分类
  function cate_add(name,pid,cat_id){
    $("#myModalLabel").html("添加分类");
    $("#name").val('');
    $("#level").val(0);
    $("#seq").val(0);
    $("#action").val('add');
    $("#pid").val(cat_id);

    if(pid == 0){
      $("#pid_name").html("顶级分类");
    }else if(name!=null){
      $("#pid_name").html(name);
    }

    $('#J_addsuppliers').click();
  }

  // 编辑分类
  function cate_edit(id,name){
    $("#myModalLabel").html("编辑分类");

    $.ajax({
      url:"{:U('Category/getInfo')}",
      type:'post',
      data:{action:'getInfo',id:id},
      dataType:'json',
      success:function(data){
        if(data.code == 1){
            $("#name").val(data.name);
            $("#level").val(data.level);
            $("#pid_name").html(name);
            $("#pid").val(data.pid);
            $("#id").val(data.id);
            $("#sort").val(data.sort);
            if(data.pid == 0){
              $("#pid_name").html("顶级分类");
            }
        }else{
            aler(data.msg);
        }
      }
    });
    $("#action").val('edit');
    $('#J_addsuppliers').click();
  }

  function del(cat_id,id){
    if(confirm("确定删除!")){
        $.ajax({
            url:"{:U('Category/del')}",
            type:'post',
            data:{action:'del',id:cat_id},
            dataType:'json',
            success:function(data){
              if(data.code == 1){
                alert(data.msg);
                $("#"+id).attr("style","display:none");
              }else{
                alert(data.msg);
              }          
            }
        })
    }
  }
</script>
</block>